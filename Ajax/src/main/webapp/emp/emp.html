<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>emp 화면</title>
  <style>
  	table {
  		width: 550px;
  		border: 1px solid #000;
  		border-collapse: collapse;
  		text-align: center;
  	}
  	th, td {
  		border: 1px solid #000;
  	}
  	th {
  		background: #000;
  		color: #fff;
  	}
  </style>
</head>

<body>
  <form name = "frm" action="../ajax.do" method="post">
  	<input type = "hidden" name = "empId">
    fist_name : <input type="text" name="fname"><br>
    last_name : <input type="text" name="lname"><br>
    email : <input type="email" name="email"><br>
    hire_date : <input type="date" name="hdate"><br>
    job_id : <input type="text" name="job" value="IT_PROG"><br>
    <input type = "hidden" name="cmd" value="insert">
    <input type="submit" value="저장">
    <input type="reset" value="취소">
    <input type="button" id = "modify" value="수정"> 
  </form>

  <h3>사원리스트</h3>
  <div id="show">
  	<table>
  		<thead>
  			<tr>
  				<th>사원번호</th>
  				<th>사원이름</th>
  				<th>사원성</th>
  				<th>이메일</th>
  				<th>입사일자</th>
  				<th>직무</th>
  			</tr>
  		</thead>
  		<tbody id = "list">
  		</tbody>
  	</table>
  </div>
  
  
  <script>	
  
  function ajaxPost(CallBackFunc) {
	  let fname = myform.fname.value;
	  let lname = myform.lname.value;
	  let email = myform.email.value;
	  let job = myform.job.value;
	  let hdate = myform.hdate.value;
	  let cmd = myform.cmd.value;
	  let empId = myform.empId.value;
  }
		// 리스트 출력 부분 
		let myform = '';
  	let xhtp = new XMLHttpRequest(); 
  	xhtp.open('GET', '../ajax.do?job=json'); // Ajax/emp/emp.html
  	xhtp.send(); 
  	xhtp.onload = function() {
  		console.log(xhtp.responseText);
  		let result = JSON.parse(xhtp.responseText);
  		let fields = ['employeeId', 'firstName', 'lastName', 'email', 'hireDate', 'jobId'];
  		let tbody = document.getElementById('list');
  		
  		result.forEach((elem) => {
  			tbody.append(makeTr(elem)); // elem => {employeeId, firstName, lastName...}
  		})
  	
  	// POST 방식으로 데이터 입력
  	myform = document.forms.frm;
  	myform.onsubmit = function(ev) {
  	ev.preventDefault(); 
  	let xhtp = new XMLHttpRequest(); 
  	xhtp.open('POST', '../ajax.do');
  	xhtp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded'); // ?key1:val1&key2:val2
  	let fname = myform.fname.value;
  	let lname = myform.lname.value;
  	let email = myform.email.value;
  	let hdate = myform.hdate.value;
  	let job = myform.job.value;
  	let cmd = myform.cmd.value;
  	let params = `cmd=${cmd}&fname=${fname}&lname=${lname}&email=${email}&hdate=${hdate}&job=${job}`;
  	xhtp.send(params); 
  	xhtp.onload = function() {
  		let data = JSON.parse(xhtp.responseText);
  		let tbody = document.getElementById('list');
  		tbody.append(makeTr(data));
  		}
  	}
  		
  	function makeTr(emp) {
  	  let tr = document.createElement('tr');
  	  tr.addEventListener('click', trClick);
  	  tr.setAttribute('id', 'key_' + emp.employeeId);
  	  fields.forEach((field) => {
  	  	let td = document.createElement('td');
  	  	td.innerText = emp[field];
  	  	tr.append(td);
  	  });
  	  return tr;
  	  }
  	}; 
  	
  	function trClick() {
  		// tr 클릭 -> this:tr
  		console.log(this.children);
  		myform.empId.value = this.children[0].innerText;
  		myform.fname.value = this.children[1].innerText;
  		myform.lname.value = this.children[2].innerText;
  		myform.email.value = this.children[3].innerText;
  		myform.hdate.value = this.children[4].innerText.substring(0, 10);
  		myform.job.value = this.children[5].innerText;
  	}
  	
  	// 수정
  	let change = document.getElementById('modify');
  	change.addEventListener('click', function(e) {
  		e.preventDefault(); 
  		myform.cmd.value = 'update';
  		let empId = myform.empId.value;
  		let fname = myform.fname.value;
  		let lname = myform.lname.value;
  		let email = myform.email.value;
  		let hdate = myform.hdate.value;
  		let job = myform.job.value;
  		let cmd = myform.cmd.value;
  		
  		let params = `cmd=${cmd}&empId=${empId}&fname=${fname}&lname=${lname}&email=${email}&hdate=${hdate}&job=${job}`;
  		let xhtp = new XMLHttpRequest(); 
  		xhtp.open('POST', '../ajax.do');
  		xhtp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  		xhtp.send(params);
  		xhtp.onload = function() {
  			let result = JSON.parse(xhtp.responseText);
  			console.log(result);
  			console.log('key_' + result.employeeId);
  			let oldTr = document.getElementById('key_' + result.employeeId);
  			console.log(oldTr);
  			let newTr = makeTr(result);
  			console.log(newTr);
  			oldTr.parentNode.replaceChild(newTr, oldTr);
  		}
  	});
  </script>
</body>

</html>